# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.
name: Virtual Machine PR

on:
  workflow_dispatch:
  pull_request:
    branches: [ main ]

env:
  APPLICATION_DIRECTORY: marketplace/virtual-machine/basic-windows-vm

jobs:
  ValidatePackerTemplate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Validate Template
        uses: hashicorp/packer-github-actions@master
        with:
          command: validate
          arguments: -syntax-only
          target: build.BasicWindowsVMImage.pkr.hcl source.windowsvhd.pkr.hcl
          working_directory: ${{ env.APPLICATION_DIRECTORY }}
  BuildValidateImage:
    runs-on: ubuntu-latest
    needs: ValidatePackerTemplate
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set Packer Variables
        uses: microsoft/variable-substitution@v1
        with:
          files: "${{ env.APPLICATION_DIRECTORY }}/variables.pkr.json"
        env:
          variable.gallery_name.default: azmp_images
          variable.image_name.default: ContosoWinVM
          variable.image_version.default: 0.0.3
          variable.resource_group_name.default: azmp-rg
          variable.subscription.default: 66cee5af-ac62-4e46-a779-feff32a4f509
          variable.temp_resource_group_name.default: basicwinvm-${{ github.run_number }}-rg
      - name: Build Image
        id: build-image
        uses: ./.github/actions/packer-build
        with:
          azureCredentials: ${{ secrets.AZURE_CREDENTIALS }}
          target: .
          workingDirectory: ${{ env.APPLICATION_DIRECTORY }}
      - name: Get Shared Image ID
        shell: pwsh
        run: |
          Write-Output ${{ steps.build-image.outputs.sharedImageId }}
